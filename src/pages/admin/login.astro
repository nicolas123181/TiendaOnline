---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase, isSupabaseConfigured } from "../../lib/supabase";

// SSR
export const prerender = false;

let error = "";

// Procesar login si hay POST
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const email = formData.get("email")?.toString() || "";
        const password = formData.get("password")?.toString() || "";

        if (!email || !password) {
            error = "Por favor completa todos los campos.";
        } else {
            const { data, error: authError } =
                await supabase.auth.signInWithPassword({
                    email,
                    password,
                });

            if (authError) {
                error = authError.message || "Credenciales incorrectas.";
            } else if (data.session) {
                // Redirect to admin dashboard
                return Astro.redirect("/admin");
            } else {
                error =
                    "No se pudo iniciar sesión. Por favor intenta de nuevo.";
            }
        }
    } catch (e) {
        error = "Ha ocurrido un error. Por favor, inténtalo de nuevo.";
        console.error("Login error:", e);
    }
}

// Verificar si ya hay sesión
const session = await supabase.auth.getSession();
if (session.data.session) {
    return Astro.redirect("/admin");
}

const isConfigured = isSupabaseConfigured;
---

<BaseLayout title="Admin Login">
    <div
        class="min-h-screen flex items-center justify-center bg-linear-to-br from-brand-navy via-brand-navy-light to-brand-charcoal p-4"
    >
        <div class="w-full max-w-md">
            <!-- Logo -->
            <div class="text-center mb-8">
                <a href="/" class="inline-block">
                    <span
                        class="text-3xl font-light tracking-[0.3em] text-white"
                    >
                        VANTAGE
                    </span>
                </a>
                <p class="text-gray-400 mt-2">Panel de Administración</p>
            </div>

            <!-- Login Card -->
            <div class="bg-surface-primary rounded-2xl shadow-strong p-8">
                <h1
                    class="text-2xl font-serif font-bold text-brand-navy text-center mb-6"
                >
                    Iniciar Sesión
                </h1>

                {
                    error && (
                        <div class="mb-6 p-4 bg-status-error-bg border border-status-error/20 rounded-xl">
                            <p class="text-sm text-status-error flex items-center gap-2">
                                <svg
                                    class="w-5 h-5 shrink-0"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                {error}
                            </p>
                        </div>
                    )
                }

                <form method="POST" class="space-y-6">
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-text-primary mb-2"
                        >
                            Email
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            autocomplete="email"
                            class="w-full px-4 py-3 rounded-xl border border-border-light bg-surface-primary focus:border-brand-navy focus:outline-none focus:ring-2 focus:ring-brand-navy/20 transition-all"
                            placeholder="admin@vantage.com"
                        />
                    </div>

                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-text-primary mb-2"
                        >
                            Contraseña
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            autocomplete="current-password"
                            class="w-full px-4 py-3 rounded-xl border border-border-light bg-surface-primary focus:border-brand-navy focus:outline-none focus:ring-2 focus:ring-brand-navy/20 transition-all"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full py-4 px-6 bg-brand-navy text-white font-medium rounded-xl hover:bg-brand-navy-light focus:outline-none focus:ring-2 focus:ring-brand-navy focus:ring-offset-2 transition-all"
                    >
                        Acceder al Panel
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a
                        href="/"
                        class="text-sm text-text-muted hover:text-brand-navy transition-colors"
                    >
                        ← Volver a la tienda
                    </a>
                </div>
            </div>

            <!-- Security Note -->
            <p class="text-center text-xs text-gray-500 mt-6">
                Acceso restringido solo a personal autorizado.
                <br />
                Todas las acciones son registradas.
            </p>
        </div>
    </div>
</BaseLayout>
