---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { supabase, isSupabaseConfigured } from "../../lib/supabase";

// Verificar si Supabase est√° configurado
if (!isSupabaseConfigured) {
    return Astro.redirect("/admin/login?error=config");
}

// Procesar formulario
let message = "";
let messageType: "success" | "error" = "success";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("action") as string;

    if (action === "create") {
        const name = formData.get("name") as string;
        const description = formData.get("description") as string;
        const slug = name
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)/g, "");

        const { error } = await supabase
            .from("categories")
            .insert({ name, slug, description });

        if (error) {
            message = `Error al crear categor√≠a: ${error.message}`;
            messageType = "error";
        } else {
            message = "Categor√≠a creada correctamente";
            messageType = "success";
        }
    } else if (action === "update") {
        const id = parseInt(formData.get("id") as string);
        const name = formData.get("name") as string;
        const description = formData.get("description") as string;

        const { error } = await supabase
            .from("categories")
            .update({ name, description })
            .eq("id", id);

        if (error) {
            message = `Error al actualizar categor√≠a: ${error.message}`;
            messageType = "error";
        } else {
            message = "Categor√≠a actualizada correctamente";
            messageType = "success";
        }
    } else if (action === "delete") {
        const id = parseInt(formData.get("id") as string);

        // Verificar si hay productos en esta categor√≠a
        const { count } = await supabase
            .from("products")
            .select("*", { count: "exact", head: true })
            .eq("category_id", id);

        if (count && count > 0) {
            message = `No se puede eliminar: hay ${count} productos en esta categor√≠a`;
            messageType = "error";
        } else {
            const { error } = await supabase
                .from("categories")
                .delete()
                .eq("id", id);

            if (error) {
                message = `Error al eliminar categor√≠a: ${error.message}`;
                messageType = "error";
            } else {
                message = "Categor√≠a eliminada correctamente";
                messageType = "success";
            }
        }
    }
}

// Obtener categor√≠as con conteo de productos
const { data: categories } = await supabase
    .from("categories")
    .select(
        `
    *,
    products:products(count)
  `,
    )
    .order("name");

// Parsear el conteo de productos
const categoriesWithCount =
    categories?.map((cat) => ({
        ...cat,
        productCount: cat.products?.[0]?.count || 0,
    })) || [];
---

<AdminLayout title="Gesti√≥n de Categor√≠as">
    <div class="page-header">
        <h1>üìÇ Gesti√≥n de Categor√≠as</h1>
        <p>Administra las categor√≠as de productos de la tienda</p>
    </div>

    {
        message && (
            <div
                class={`alert ${messageType === "error" ? "alert-error" : "alert-success"}`}
            >
                {message}
            </div>
        )
    }

    <!-- Formulario para crear nueva categor√≠a -->
    <div class="card create-form">
        <h2>‚ûï Crear Nueva Categor√≠a</h2>
        <form method="POST">
            <input type="hidden" name="action" value="create" />
            <div class="form-row">
                <div class="form-group">
                    <label for="name">Nombre de la categor√≠a *</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        placeholder="Ej: Camisas"
                    />
                </div>
                <div class="form-group flex-2">
                    <label for="description">Descripci√≥n</label>
                    <input
                        type="text"
                        id="description"
                        name="description"
                        placeholder="Descripci√≥n breve de la categor√≠a"
                    />
                </div>
                <div class="form-group form-actions">
                    <button type="submit" class="btn btn-primary"
                        >Crear Categor√≠a</button
                    >
                </div>
            </div>
        </form>
    </div>

    <!-- Lista de categor√≠as existentes -->
    <div class="card">
        <h2>üìã Categor√≠as Existentes ({categoriesWithCount.length})</h2>

        {
            categoriesWithCount.length === 0 ? (
                <div class="empty-state">
                    <p>No hay categor√≠as creadas</p>
                </div>
            ) : (
                <div class="categories-grid">
                    {categoriesWithCount.map((category) => (
                        <div class="category-card" data-id={category.id}>
                            <div class="category-header">
                                <h3 class="category-name">{category.name}</h3>
                                <span class="product-count">
                                    {category.productCount} productos
                                </span>
                            </div>
                            <p class="category-slug">/{category.slug}</p>
                            <p class="category-description">
                                {category.description || "Sin descripci√≥n"}
                            </p>

                            <div class="category-actions">
                                <button
                                    type="button"
                                    class="btn btn-sm btn-secondary edit-btn"
                                    data-id={category.id}
                                    data-name={category.name}
                                    data-description={
                                        category.description || ""
                                    }
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                                {category.productCount === 0 ? (
                                    <form
                                        method="POST"
                                        style="display: inline;"
                                        onsubmit="return confirm('¬øSeguro que deseas eliminar esta categor√≠a?')"
                                    >
                                        <input
                                            type="hidden"
                                            name="action"
                                            value="delete"
                                        />
                                        <input
                                            type="hidden"
                                            name="id"
                                            value={category.id}
                                        />
                                        <button
                                            type="submit"
                                            class="btn btn-sm btn-danger"
                                        >
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </form>
                                ) : (
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-disabled"
                                        disabled
                                        title="Hay productos en esta categor√≠a"
                                    >
                                        üîí En uso
                                    </button>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )
        }
    </div>

    <!-- Modal de edici√≥n -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Editar Categor√≠a</h2>
            <form method="POST">
                <input type="hidden" name="action" value="update" />
                <input type="hidden" name="id" id="edit-id" />
                <div class="form-group">
                    <label for="edit-name">Nombre</label>
                    <input type="text" id="edit-name" name="name" required />
                </div>
                <div class="form-group">
                    <label for="edit-description">Descripci√≥n</label>
                    <textarea id="edit-description" name="description" rows="3"
                    ></textarea>
                </div>
                <div class="modal-actions">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        id="close-modal">Cancelar</button
                    >
                    <button type="submit" class="btn btn-primary"
                        >Guardar Cambios</button
                    >
                </div>
            </form>
        </div>
    </div>
</AdminLayout>

<style>
    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        color: var(--navy);
        margin: 0 0 0.5rem 0;
    }

    .page-header p {
        color: #6b7280;
        margin: 0;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
        font-size: 1.25rem;
        color: var(--navy);
        margin: 0 0 1.5rem 0;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-weight: 500;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #dc2626;
    }

    .form-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .form-group {
        flex: 1;
    }

    .form-group.flex-2 {
        flex: 2;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition:
            border-color 0.2s,
            box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--navy);
        box-shadow: 0 0 0 3px rgba(26, 39, 68, 0.1);
    }

    .form-actions {
        flex: 0 0 auto;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--navy);
        color: white;
    }

    .btn-primary:hover {
        background: #2d4a6f;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-danger {
        background: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
    }

    .btn-disabled {
        background: #e5e7eb;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .category-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.2s;
    }

    .category-card:hover {
        border-color: var(--navy);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .category-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--navy);
        margin: 0;
    }

    .product-count {
        background: var(--navy);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .category-slug {
        color: #9ca3af;
        font-size: 0.85rem;
        font-family: monospace;
        margin: 0 0 0.5rem 0;
    }

    .category-description {
        color: #6b7280;
        font-size: 0.9rem;
        margin: 0 0 1rem 0;
        line-height: 1.4;
    }

    .category-actions {
        display: flex;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-content h2 {
        margin: 0 0 1.5rem 0;
        border: none;
        padding: 0;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .categories-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Modal de edici√≥n
    const modal = document.getElementById("edit-modal");
    const editBtns = document.querySelectorAll(".edit-btn");
    const closeModal = document.getElementById("close-modal");

    editBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const name = btn.getAttribute("data-name");
            const description = btn.getAttribute("data-description");

            (document.getElementById("edit-id") as HTMLInputElement).value =
                id || "";
            (document.getElementById("edit-name") as HTMLInputElement).value =
                name || "";
            (
                document.getElementById(
                    "edit-description",
                ) as HTMLTextAreaElement
            ).value = description || "";

            modal?.classList.add("active");
        });
    });

    closeModal?.addEventListener("click", () => {
        modal?.classList.remove("active");
    });

    modal?.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.classList.remove("active");
        }
    });
</script>
