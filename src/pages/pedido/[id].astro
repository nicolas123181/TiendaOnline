---
import PublicLayout from "../../layouts/PublicLayout.astro";

export const prerender = false;

const orderId = Astro.params.id;
---

<PublicLayout
    title={`Pedido #${orderId} - Vantage`}
    description="Detalle de tu pedido"
>
    <section class="py-12">
        <div class="max-w-3xl mx-auto px-4">
            <!-- Loading State -->
            <div
                id="loading-state"
                class="flex items-center justify-center py-16"
            >
                <div class="text-center">
                    <div
                        class="w-12 h-12 border-4 border-gray-200 border-t-blue-900 rounded-full animate-spin mx-auto mb-4"
                    >
                    </div>
                    <p class="text-gray-600">Cargando pedido...</p>
                </div>
            </div>

            <!-- Not Found State -->
            <div id="not-found-state" class="hidden text-center py-16">
                <div
                    class="w-20 h-20 mx-auto mb-6 bg-red-50 rounded-full flex items-center justify-center"
                >
                    <svg
                        class="w-10 h-10 text-red-500"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">
                    Pedido no encontrado
                </h2>
                <p class="text-gray-600 mb-6">
                    No se encontró el pedido o no tienes permiso para verlo.
                </p>
                <a
                    href="/perfil"
                    class="inline-flex items-center gap-2 px-6 py-3 bg-brand-navy text-white font-semibold rounded-xl hover:bg-brand-navy-light transition-colors"
                >
                    Volver a Mis Pedidos
                </a>
            </div>

            <!-- Order Content -->
            <div id="order-content" class="hidden">
                <!-- Header -->
                <div class="mb-8">
                    <a
                        href="/perfil"
                        class="inline-flex items-center gap-2 text-brand-navy font-medium hover:underline mb-4"
                    >
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Volver a Mis Pedidos
                    </a>
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h1
                                class="text-3xl font-serif font-bold text-brand-navy"
                                id="order-number"
                            >
                                Pedido #00000
                            </h1>
                            <p class="text-text-muted" id="order-date">
                                Fecha del pedido
                            </p>
                        </div>
                        <span
                            id="order-status"
                            class="px-4 py-2 text-sm font-semibold rounded-full bg-gray-100 text-gray-800"
                        >
                            Estado
                        </span>
                    </div>
                </div>

                <!-- Order Summary Card -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6"
                >
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-lg font-semibold text-gray-900">
                            Productos
                        </h2>
                    </div>
                    <div id="order-items" class="divide-y divide-gray-100">
                        <!-- Items will be inserted here -->
                    </div>
                    <div class="p-6 bg-gray-50">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="order-subtotal" class="font-medium"
                                    >0,00 €</span
                                >
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Envío</span>
                                <span id="order-shipping" class="font-medium"
                                    >0,00 €</span
                                >
                            </div>
                            <div
                                id="discount-row"
                                class="hidden flex justify-between text-green-600"
                            >
                                <span>Descuento</span>
                                <span id="order-discount">-0,00 €</span>
                            </div>
                            <div
                                class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200"
                            >
                                <span>Total</span>
                                <span id="order-total" class="text-brand-navy"
                                    >0,00 €</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Info -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6"
                >
                    <div class="p-6 border-b border-gray-100">
                        <h2 class="text-lg font-semibold text-gray-900">
                            Dirección de Envío
                        </h2>
                    </div>
                    <div class="p-6">
                        <p id="shipping-name" class="font-medium text-gray-900">
                        </p>
                        <p id="shipping-address" class="text-gray-600"></p>
                        <p id="shipping-city" class="text-gray-600"></p>
                        <p id="shipping-phone" class="text-gray-500 mt-2"></p>
                    </div>
                </div>

                <!-- Cancel Order Section (only shown for "paid" orders) -->
                <div
                    id="cancel-order-section"
                    class="hidden bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl shadow-sm border border-red-100 overflow-hidden mb-6"
                >
                    <div class="p-6">
                        <div class="flex items-start gap-4">
                            <div class="p-3 bg-red-100 rounded-xl shrink-0">
                                <svg
                                    class="w-6 h-6 text-red-600"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">
                                    ¿Deseas cancelar el pedido?
                                </h3>
                                <p class="text-sm text-gray-600 mb-4">
                                    Tu pedido aún no ha sido enviado. Puedes
                                    cancelarlo y el stock será restaurado
                                    automáticamente.
                                </p>
                                <button
                                    id="cancel-order-btn"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition-colors"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                        ></path>
                                    </svg>
                                    Cancelar Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Section -->
                <div
                    id="factura"
                    class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-sm border border-blue-100 overflow-hidden"
                >
                    <div class="p-6 border-b border-blue-100">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg
                                    class="w-6 h-6 text-blue-600"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                    ></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-lg font-semibold text-gray-900">
                                    Tu Factura
                                </h2>
                                <p
                                    id="invoice-number"
                                    class="text-sm text-gray-600"
                                >
                                    Cargando...
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">
                            Descarga tu factura para este pedido.
                        </p>
                        <button
                            id="download-invoice-btn"
                            class="w-full inline-flex justify-center items-center gap-2 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl"
                        >
                            <svg
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                ></path>
                            </svg>
                            Descargar Factura
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pasar el orderId como data attribute -->
    <div id="order-data" data-order-id={orderId} class="hidden"></div>
</PublicLayout>

<script>
    import { createClient } from "@supabase/supabase-js";

    const supabaseUrl =
        import.meta.env.PUBLIC_SUPABASE_URL ||
        "https://kggjqbhcvvayqwkbpwvp.supabase.co";
    const supabaseAnonKey =
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY ||
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnZ2pxYmhjdnZheXF3a2Jwd3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNDI2NDQsImV4cCI6MjA1MTgxODY0NH0.P9eqbIFVBt2IuHnzTcCDbGb6w72xR-AQ60aKEkqJnYY";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    // Obtener el orderId del data attribute
    const orderDataEl = document.getElementById("order-data");
    const orderId = orderDataEl?.dataset.orderId || "";

    const loadingState = document.getElementById("loading-state");
    const notFoundState = document.getElementById("not-found-state");
    const orderContent = document.getElementById("order-content");

    function formatPrice(cents: number): string {
        return new Intl.NumberFormat("es-ES", {
            style: "currency",
            currency: "EUR",
        }).format(cents / 100);
    }

    const statusLabels: Record<string, string> = {
        pending: "Pendiente de Pago",
        paid: "Pagado",
        ready_for_pickup: "Listo para Recoger",
        shipped: "Enviado",
        delivered: "Entregado",
        cancelled: "Cancelado",
    };

    const statusColors: Record<string, string> = {
        pending: "bg-yellow-100 text-yellow-800",
        paid: "bg-blue-100 text-blue-800",
        ready_for_pickup: "bg-orange-100 text-orange-800",
        shipped: "bg-purple-100 text-purple-800",
        delivered: "bg-green-100 text-green-800",
        cancelled: "bg-red-100 text-red-800",
    };

    async function loadOrder() {
        if (!orderId) {
            loadingState?.classList.add("hidden");
            notFoundState?.classList.remove("hidden");
            return;
        }

        try {
            // Verificar sesión
            const {
                data: { session },
            } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = "/login?returnTo=/pedido/" + orderId;
                return;
            }

            // Cargar pedido con información de productos
            const { data: order, error } = await supabase
                .from("orders")
                .select(
                    `
                    *,
                    order_items(
                        *,
                        product:products(
                            id,
                            name,
                            slug,
                            images
                        )
                    )
                `,
                )
                .eq("id", orderId)
                .eq("customer_email", session.user.email)
                .single();

            if (error || !order) {
                console.error("Order error:", error);
                loadingState?.classList.add("hidden");
                notFoundState?.classList.remove("hidden");
                return;
            }

            // Mostrar datos del pedido
            const orderNumberEl = document.getElementById("order-number");
            if (orderNumberEl) {
                orderNumberEl.textContent = `Pedido #${order.id.toString().padStart(5, "0")}`;
            }

            const orderDateEl = document.getElementById("order-date");
            if (orderDateEl) {
                orderDateEl.textContent = new Date(
                    order.created_at,
                ).toLocaleDateString("es-ES", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            }

            const statusEl = document.getElementById("order-status");
            if (statusEl) {
                statusEl.textContent =
                    statusLabels[order.status] || order.status;
                statusEl.className = `px-4 py-2 text-sm font-semibold rounded-full ${statusColors[order.status] || "bg-gray-100 text-gray-800"}`;
            }

            // Items
            const itemsContainer = document.getElementById("order-items");
            if (itemsContainer && order.order_items) {
                itemsContainer.innerHTML = order.order_items
                    .map((item: any) => {
                        const productImage =
                            item.product?.images?.[0] ||
                            "/placeholder-product.jpg";
                        const productSlug = item.product?.slug;
                        return `
                    <div class="p-6 flex items-center gap-4">
                        ${
                            productSlug
                                ? `
                            <a href="/productos/${productSlug}" class="shrink-0 w-20 h-20 rounded-lg overflow-hidden border border-gray-200 hover:border-brand-navy transition-colors">
                                <img src="${productImage}" alt="${item.product_name}" class="w-full h-full object-cover" />
                            </a>
                        `
                                : `
                            <div class="shrink-0 w-20 h-20 rounded-lg overflow-hidden border border-gray-200 bg-gray-50 flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        `
                        }
                        <div class="flex-1">
                            ${
                                productSlug
                                    ? `
                                <a href="/productos/${productSlug}" class="font-medium text-brand-navy hover:underline">${item.product_name}</a>
                            `
                                    : `
                                <p class="font-medium text-gray-900">${item.product_name}</p>
                            `
                            }
                            ${item.size ? `<p class="text-sm text-gray-500">Talla: ${item.size}</p>` : ""}
                            <p class="text-sm text-gray-500">Cantidad: ${item.quantity}</p>
                        </div>
                        <p class="font-semibold text-gray-900">${formatPrice(item.product_price * item.quantity)}</p>
                    </div>
                `;
                    })
                    .join("");
            }

            // Totales
            const subtotalEl = document.getElementById("order-subtotal");
            if (subtotalEl)
                subtotalEl.textContent = formatPrice(
                    order.subtotal || order.total,
                );

            const shippingEl = document.getElementById("order-shipping");
            if (shippingEl)
                shippingEl.textContent = formatPrice(order.shipping_cost || 0);

            const totalEl = document.getElementById("order-total");
            if (totalEl) totalEl.textContent = formatPrice(order.total);

            if (order.discount > 0) {
                const discountRow = document.getElementById("discount-row");
                const discountEl = document.getElementById("order-discount");
                if (discountRow) discountRow.classList.remove("hidden");
                if (discountEl)
                    discountEl.textContent = `-${formatPrice(order.discount)}`;
            }

            // Dirección
            const nameEl = document.getElementById("shipping-name");
            if (nameEl) nameEl.textContent = order.customer_name;

            const addressEl = document.getElementById("shipping-address");
            if (addressEl) addressEl.textContent = order.customer_address;

            const cityEl = document.getElementById("shipping-city");
            if (cityEl)
                cityEl.textContent = `${order.customer_postal_code} ${order.customer_city}`;

            const phoneEl = document.getElementById("shipping-phone");
            if (phoneEl)
                phoneEl.textContent = order.customer_phone
                    ? `Tel: ${order.customer_phone}`
                    : "";

            // Mostrar contenido
            loadingState?.classList.add("hidden");
            orderContent?.classList.remove("hidden");

            // Mostrar sección de cancelación si el estado es 'paid'
            const cancelSection = document.getElementById(
                "cancel-order-section",
            );
            if (cancelSection) {
                console.log(
                    "Checking order status for cancellation:",
                    order.status,
                );
                if (order.status === "paid") {
                    cancelSection.classList.remove("hidden");
                } else {
                    cancelSection.classList.add("hidden");
                }
            }

            // Load invoice info
            await loadInvoiceInfo();
        } catch (error) {
            console.error("Error loading order:", error);
            loadingState?.classList.add("hidden");
            notFoundState?.classList.remove("hidden");
        }
    }

    // Invoice functionality
    async function loadInvoiceInfo() {
        try {
            const { data: invoice, error } = await supabase
                .from("invoices")
                .select("invoice_number, id")
                .eq("order_id", orderId)
                .single();

            if (!error && invoice) {
                const invoiceNumberEl =
                    document.getElementById("invoice-number");
                if (invoiceNumberEl) {
                    invoiceNumberEl.textContent = `Factura Nº ${invoice.invoice_number}`;
                }
            }
        } catch (error) {
            console.error("Error loading invoice info:", error);
        }
    }

    // Download invoice - opens in new tab
    const downloadInvoiceBtn = document.getElementById("download-invoice-btn");
    downloadInvoiceBtn?.addEventListener("click", () => {
        window.open(`/api/invoice/${orderId}`, "_blank");
    });

    loadOrder();

    // Handler del botón de cancelación
    const cancelOrderBtn = document.getElementById("cancel-order-btn");
    cancelOrderBtn?.addEventListener("click", async () => {
        const confirmed = confirm(
            "⚠️ ¿Estás seguro de que deseas cancelar este pedido?\n\n" +
                "Esta acción no se puede deshacer. El stock de los productos será restaurado automáticamente.",
        );

        if (!confirmed) return;

        const btn = cancelOrderBtn as HTMLButtonElement;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            Cancelando...
        `;

        try {
            const response = await fetch("/api/orders/cancel", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId: parseInt(orderId) }),
            });

            let result;
            try {
                const text = await response.text();
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    // If not JSON, it might be an HTML error page (404/500)
                    console.error("Non-JSON response:", text);
                    throw new Error(
                        `Server returned non-JSON response: ${response.status} ${response.statusText}`,
                    );
                }

                if (result.success) {
                    alert("✅ " + result.message);
                    window.location.reload();
                } else {
                    alert(
                        "❌ " + (result.error || "Error al cancelar el pedido"),
                    );
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error("Cancel parsing error:", error);
                alert(
                    `❌ Error del servidor (${response.status}): No se pudo procesar la respuesta.`,
                );
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            console.error("Cancel order error:", error);
            alert("❌ Error de conexión. Inténtalo de nuevo.");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
