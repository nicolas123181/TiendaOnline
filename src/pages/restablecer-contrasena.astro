---
import PublicLayout from "../layouts/PublicLayout.astro";

export const prerender = false;
---

<PublicLayout
    title="Restablecer Contraseña - Vantage"
    description="Establece tu nueva contraseña"
>
    <section class="min-h-[70vh] flex items-center justify-center py-12 px-4">
        <div class="w-full max-w-md">
            <!-- Card -->
            <div
                class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8"
            >
                <!-- Logo -->
                <div class="text-center mb-8">
                    <a href="/" class="inline-block">
                        <h1
                            class="text-2xl tracking-[0.3em] font-light text-[#1a2744]"
                        >
                            VANTAGE
                        </h1>
                    </a>
                    <div class="w-12 h-px bg-amber-600 mx-auto mt-3"></div>
                </div>

                <!-- Título -->
                <div class="text-center mb-8">
                    <h2 class="text-xl font-serif text-gray-900 mb-2">
                        Nueva Contraseña
                    </h2>
                    <p class="text-gray-600 text-sm">
                        Introduce tu nueva contraseña para tu cuenta.
                    </p>
                </div>

                <!-- Formulario -->
                <form id="reset-password-form" class="space-y-6">
                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Nueva Contraseña
                        </label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            minlength="6"
                            placeholder="Mínimo 6 caracteres"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#1a2744]/20 focus:border-[#1a2744] transition-all"
                        />
                    </div>

                    <div>
                        <label
                            for="confirm-password"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Confirmar Contraseña
                        </label>
                        <input
                            type="password"
                            id="confirm-password"
                            name="confirm-password"
                            required
                            minlength="6"
                            placeholder="Repite la contraseña"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#1a2744]/20 focus:border-[#1a2744] transition-all"
                        />
                    </div>

                    <!-- Mensajes -->
                    <div
                        id="error-message"
                        class="hidden p-4 bg-red-50 text-red-700 text-sm rounded-xl"
                    >
                    </div>

                    <div
                        id="success-message"
                        class="hidden p-4 bg-green-50 text-green-700 text-sm rounded-xl"
                    >
                    </div>

                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full py-3.5 bg-[#1a2744] text-white font-medium rounded-xl hover:bg-[#243555] transition-colors flex items-center justify-center gap-2"
                    >
                        Restablecer Contraseña
                    </button>
                </form>

                <!-- Links -->
                <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-600">
                        <a
                            href="/login"
                            class="text-[#1a2744] font-medium hover:underline"
                        >
                            Volver al inicio de sesión
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </section>
</PublicLayout>

<script>
    import { createClient } from "@supabase/supabase-js";

    const supabaseUrl =
        import.meta.env.PUBLIC_SUPABASE_URL ||
        "https://kggjqbhcvvayqwkbpwvp.supabase.co";
    const supabaseAnonKey =
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY ||
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnZ2pxYmhjdnZheXF3a2Jwd3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNDI2NDQsImV4cCI6MjA1MTgxODY0NH0.P9eqbIFVBt2IuHnzTcCDbGb6w72xR-AQ60aKEkqJnYY";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const form = document.getElementById(
        "reset-password-form",
    ) as HTMLFormElement;
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;
    const errorMessage = document.getElementById(
        "error-message",
    ) as HTMLDivElement;
    const successMessage = document.getElementById(
        "success-message",
    ) as HTMLDivElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const password = (
            document.getElementById("password") as HTMLInputElement
        ).value;
        const confirmPassword = (
            document.getElementById("confirm-password") as HTMLInputElement
        ).value;

        // Reset messages
        errorMessage.classList.add("hidden");
        successMessage.classList.add("hidden");

        // Validaciones
        if (password !== confirmPassword) {
            errorMessage.textContent = "Las contraseñas no coinciden";
            errorMessage.classList.remove("hidden");
            return;
        }

        if (password.length < 6) {
            errorMessage.textContent =
                "La contraseña debe tener al menos 6 caracteres";
            errorMessage.classList.remove("hidden");
            return;
        }

        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            Guardando...
        `;

        try {
            const { error } = await supabase.auth.updateUser({
                password: password,
            });

            if (error) {
                throw error;
            }

            successMessage.textContent =
                "Contraseña actualizada correctamente. Redirigiendo...";
            successMessage.classList.remove("hidden");

            // Redirigir al login después de 2 segundos
            setTimeout(() => {
                window.location.href = "/login";
            }, 2000);
        } catch (error: any) {
            console.error("Reset password error:", error);
            errorMessage.textContent =
                error.message || "Error al restablecer la contraseña";
            errorMessage.classList.remove("hidden");
            submitBtn.disabled = false;
            submitBtn.textContent = "Restablecer Contraseña";
        }
    });
</script>
