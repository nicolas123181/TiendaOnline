---
import PublicLayout from "../layouts/PublicLayout.astro";
import { formatPrice } from "../lib/utils";

export const prerender = false;

// La autenticación se maneja del lado del cliente (igual que /perfil)
// No se hace ninguna verificación del lado del servidor
---

<PublicLayout title="Mis Favoritos" description="Tu lista de deseos en Vantage">
    <section class="py-12 lg:py-16 min-h-screen bg-surface-secondary">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Loading State -->
            <div id="loading-state" class="flex items-center justify-center py-16">
                <div class="text-center">
                    <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-900 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">Cargando favoritos...</p>
                </div>
            </div>

            <!-- Not Logged In State -->
            <div id="not-logged-state" class="hidden">
                <div class="mb-10">
                    <nav class="flex items-center gap-2 text-sm text-text-muted mb-4">
                        <a href="/" class="hover:text-brand-navy transition-colors">Inicio</a>
                        <span>/</span>
                        <span class="text-text-primary">Favoritos</span>
                    </nav>
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-7 h-7 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-3xl lg:text-4xl font-serif font-bold text-brand-navy">Mis Favoritos</h1>
                            <p class="text-text-secondary mt-1">Inicia sesión para ver tus favoritos</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-12 text-center shadow-sm">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-blue-100 flex items-center justify-center">
                        <svg class="w-12 h-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-brand-navy mb-3">Inicia sesión para ver tus favoritos</h2>
                    <p class="text-text-muted max-w-md mx-auto mb-8">
                        Para guardar productos en tu lista de favoritos y recibir notificaciones de stock, necesitas iniciar sesión.
                    </p>
                    <a 
                        href="/login?redirect=%2Ffavoritos"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-brand-navy text-white font-medium rounded-xl hover:bg-brand-navy-light transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                        </svg>
                        Iniciar Sesión
                    </a>
                </div>
            </div>

            <!-- Wishlist Content -->
            <div id="wishlist-content" class="hidden">
                <!-- Contenido generado dinámicamente por JavaScript --></div>
            </div>
        </div>
    </section>
</PublicLayout>

<script>
    import { createClient } from "@supabase/supabase-js";

    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "https://kggjqbhcvvayqwkbpwvp.supabase.co";
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtnZ2pxYmhjdnZheXF3a2Jwd3ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYyNDI2NDQsImV4cCI6MjA1MTgxODY0NH0.P9eqbIFVBt2IuHnzTcCDbGb6w72xR-AQ60aKEkqJnYY";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const loadingState = document.getElementById('loading-state');
    const notLoggedState = document.getElementById('not-logged-state');
    const wishlistContent = document.getElementById('wishlist-content');

    function formatPrice(cents: number): string {
        return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(cents / 100);
    }

    async function loadWishlist() {
        try {
            const { data: { session }, error } = await supabase.auth.getSession();

            if (!session) {
                loadingState?.classList.add('hidden');
                notLoggedState?.classList.remove('hidden');
                return;
            }

            const user = session.user;

            // Cargar wishlist
            const { data: wishlistData, error: wishlistError } = await supabase
                .from('wishlist')
                .select(`*, product:products(*)`)
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (wishlistError) {
                console.error('Error loading wishlist:', wishlistError);
                renderError();
                return;
            }

            renderWishlist(wishlistData || []);
        } catch (error) {
            console.error('Error loading wishlist:', error);
            renderError();
        }
    }

    function renderError() {
        loadingState?.classList.add('hidden');
        if (wishlistContent) {
            wishlistContent.classList.remove('hidden');
            wishlistContent.innerHTML = `
                <div class="bg-white rounded-2xl p-12 text-center shadow-sm">
                    <div class="text-red-500 mb-4">⚠️</div>
                    <p class="text-gray-600">Error al cargar tus favoritos</p>
                </div>
            `;
        }
    }

    function renderWishlist(items: any[]) {
        loadingState?.classList.add('hidden');
        
        if (!wishlistContent) return;
        
        wishlistContent.classList.remove('hidden');

        // Header
        const header = `
            <div class="mb-10">
                <nav class="flex items-center gap-2 text-sm text-text-muted mb-4">
                    <a href="/" class="hover:text-brand-navy transition-colors">Inicio</a>
                    <span>/</span>
                    <span class="text-text-primary">Favoritos</span>
                </nav>
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center">
                        <svg class="w-7 h-7 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl lg:text-4xl font-serif font-bold text-brand-navy">Mis Favoritos</h1>
                        <p class="text-text-secondary mt-1">${items.length} ${items.length === 1 ? 'producto guardado' : 'productos guardados'}</p>
                    </div>
                </div>
            </div>
        `;

        if (items.length === 0) {
            wishlistContent.innerHTML = header + `
                <div class="bg-white rounded-2xl p-12 text-center shadow-sm">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gray-100 flex items-center justify-center">
                        <svg class="w-12 h-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-brand-navy mb-3">Tu lista de favoritos está vacía</h2>
                    <p class="text-text-muted max-w-md mx-auto mb-8">
                        Explora nuestra colección y añade productos a tus favoritos haciendo clic en el icono del corazón.
                    </p>
                    <a href="/productos" class="inline-flex items-center gap-2 px-6 py-3 bg-brand-navy text-white font-medium rounded-xl hover:bg-brand-navy-light transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Explorar Productos
                    </a>
                </div>
            `;
            return;
        }

        const itemsHtml = items.map(item => {
            const product = item.product;
            if (!product) return '';

            const price = product.is_on_sale && product.sale_price ? product.sale_price : product.price;
            const originalPrice = product.is_on_sale ? product.price : null;
            const image = product.images?.[0] || '/placeholder-product.jpg';
            const stockInfo = product.stock || 0;
            const isLowStock = stockInfo > 0 && stockInfo < 9;
            const isOutOfStock = stockInfo === 0;

            return `
                <div class="wishlist-item bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex flex-col sm:flex-row">
                        <a href="/productos/${product.slug}" class="relative w-full sm:w-48 h-56 sm:h-auto shrink-0 overflow-hidden">
                            <img src="${image}" alt="${product.name}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
                            ${product.is_on_sale ? '<span class="absolute top-3 left-3 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">OFERTA</span>' : ''}
                        </a>
                        <div class="flex-1 p-6 flex flex-col justify-between">
                            <div>
                                <a href="/productos/${product.slug}" class="text-lg font-semibold text-brand-navy hover:underline">${product.name}</a>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-700 text-sm font-medium rounded-full">Talla ${item.size}</span>
                                    ${isLowStock ? '<span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 text-amber-700 text-sm font-medium rounded-full">¡Pocas unidades!</span>' : ''}
                                    ${isOutOfStock ? '<span class="inline-flex items-center gap-1 px-3 py-1 bg-red-100 text-red-700 text-sm font-medium rounded-full">Agotado</span>' : ''}
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="flex items-baseline gap-2 mb-4">
                                    <span class="text-2xl font-bold text-brand-navy">${formatPrice(price)}</span>
                                    ${originalPrice ? `<span class="text-lg text-gray-400 line-through">${formatPrice(originalPrice)}</span>` : ''}
                                </div>
                                <div class="flex gap-3">
                                    ${!isOutOfStock ? `<a href="/productos/${product.slug}" class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 px-6 py-3 bg-brand-navy text-white font-medium rounded-xl hover:bg-brand-navy-light transition-colors">Comprar ahora</a>` : '<span class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 px-6 py-3 bg-gray-100 text-gray-400 font-medium rounded-xl cursor-not-allowed">No disponible</span>'}
                                    <button type="button" class="remove-wishlist-btn p-3 rounded-xl border-2 border-gray-200 text-gray-400 hover:border-red-200 hover:text-red-500 hover:bg-red-50 transition-colors" data-product-id="${item.product_id}" data-size="${item.size}">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        wishlistContent.innerHTML = header + `<div class="grid gap-6">${itemsHtml}</div>`;

        // Agregar event listeners
        document.querySelectorAll('.remove-wishlist-btn').forEach(btn => {
            btn.addEventListener('click', handleRemoveFromWishlist);
        });
    }

    async function handleRemoveFromWishlist(e: Event) {
        const button = e.currentTarget as HTMLElement;
        const productId = button.getAttribute('data-product-id');
        const size = button.getAttribute('data-size');
        
        if (!productId || !size) return;
        
        button.classList.add('opacity-50', 'pointer-events-none');
        
        try {
            const res = await fetch(`/api/wishlist?productId=${productId}&size=${encodeURIComponent(size)}`, {
                method: 'DELETE'
            });
            
            if (res.ok) {
                const item = button.closest('.wishlist-item');
                if (item) {
                    item.classList.add('opacity-0', 'scale-95', 'transition-all', 'duration-300');
                    setTimeout(() => {
                        item.remove();
                        const remaining = document.querySelectorAll('.wishlist-item');
                        if (remaining.length === 0) {
                            loadWishlist();
                        }
                    }, 300);
                }
            } else {
                button.classList.remove('opacity-50', 'pointer-events-none');
                alert('Error al eliminar de favoritos');
            }
        } catch (e) {
            button.classList.remove('opacity-50', 'pointer-events-none');
            alert('Error de conexión');
        }
    }

    // Cargar wishlist al cargar la página
    loadWishlist();
</script>
